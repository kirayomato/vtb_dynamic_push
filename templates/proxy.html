<!DOCTYPE html>
<html>
<head>
    <title>å›¾ç‰‡åä»£æœåŠ¡ - è¯·æ±‚è®°å½•</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .stats { background: #e8f4ff; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .log-entry { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 5px; background: #fafafa; }
        .log-entry.success { border-left: 4px solid #28a745; }
        .log-entry.error { border-left: 4px solid #dc3545; }
        .timestamp { color: #666; font-size: 0.9em; }
        .url { color: #007bff; word-break: break-all; margin: 5px 0; }
        .status { font-weight: bold; }
        .status.success { color: #28a745; }
        .status.error { color: #dc3545; }
        .error-msg { color: #dc3545; font-size: 0.9em; margin-top: 5px; }
        .thumbnail { max-width: 200px; max-height: 150px; border: 1px solid #ddd; border-radius: 3px; margin-top: 10px; }
        .no-records { text-align: center; color: #666; padding: 40px; }
        .refresh-btn { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; text-decoration: none; display: inline-block; margin: 10px 0; }
        .refresh-btn:hover { background: #0056b3; }
        .clear-btn { background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        .clear-btn:hover { background: #c82333; }
        .proxy-btn { background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-left: 10px; }
        .proxy-btn:hover { background: #218838; }
        .actions { margin: 15px 0; }
        .proxy-form { background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0; }
        .proxy-input { width: 70%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .proxy-result { margin-top: 10px; padding: 10px; border-radius: 4px; display: none; }
        .proxy-result.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .proxy-result.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ–¼ï¸ å›¾ç‰‡åä»£æœåŠ¡ - è¯·æ±‚è®°å½•</h1>
        <div class="stats" id="stats">
            <strong>ç»Ÿè®¡ä¿¡æ¯ï¼š</strong> æ€»è®°å½•æ•°: {{ total }} | æˆåŠŸ: {{ success }} | å¤±è´¥: {{ failed }}
        </div>
        <div class="proxy-form">
            <h3>ğŸ”— åˆ›å»ºåä»£è¯·æ±‚</h3>
            <div style="display: flex; align-items: center;">
                <input type="text" id="proxyUrl" class="proxy-input" placeholder="è¾“å…¥å¾®åšå›¾ç‰‡URL (æ”¯æŒ .jpg, .jpeg, .png, .gif, .webp, .mp4, .mov, .flv)" />
                <button onclick="createProxyRequest()" class="proxy-btn">ğŸš€ åˆ›å»ºåä»£</button>
            </div>
            <div id="proxyResult" class="proxy-result"></div>
        </div>
        <div class="actions">
            <button onclick="refreshLogs()" class="refresh-btn">ğŸ”„ åˆ·æ–°è®°å½•</button>
            <button onclick="clearLogs()" class="clear-btn">ğŸ—‘ï¸ æ¸…ç©ºè®°å½•</button>
        </div>
        <div id="logsContainer">
            {% if logs %}
                {% for log in logs %}
                <div class="log-entry {{ 'success' if log.status == 'success' else 'error' }}">
                    <div class="timestamp">ğŸ• {{ log.timestamp }}</div>
                    <div class="url">ğŸ”— {{ log.url }}</div>
                    <div class="status {{ 'success' if log.status == 'success' else 'error' }}">
                        {{ 'âœ… æˆåŠŸ' if log.status == 'success' else 'âŒ å¤±è´¥' }}
                    </div>
                    {% if log.error %}
                    <div class="error-msg">âŒ {{ log.error }}</div>
                    {% endif %}
                    {% if log.thumbnail %}
                    <img src="/proxy?url={{ log.thumbnail | urlencode }}" class="thumbnail" alt="ç¼©ç•¥å›¾" onerror="this.style.display='none'" />
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="no-records">
                    æš‚æ— è¯·æ±‚è®°å½•ï¼Œç­‰å¾…ä»£ç†è¯·æ±‚...
                </div>
            {% endif %}
        </div>
    </div>
    <script>
        function clearLogs() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®°å½•å—ï¼Ÿ')) {
                fetch('/clear', { method: 'POST' })
                    .then(() => refreshLogs());
            }
        }
        
        function refreshLogs() {
            
            fetch('/api/logs')
                .then(response => response.json())
                .then(data => {
                    updateStats(data.total, data.success, data.failed);
                    updateLogs(data.logs);
                })
                .catch(error => {
                    console.error('åˆ·æ–°è®°å½•å¤±è´¥:', error);
                });
        }
        
        function updateStats(total, success, failed) {
            const statsDiv = document.getElementById('stats');
            statsDiv.innerHTML = `<strong>ç»Ÿè®¡ä¿¡æ¯ï¼š</strong> æ€»è®°å½•æ•°: ${total} | æˆåŠŸ: ${success} | å¤±è´¥: ${failed}`;
        }
        
        function updateLogs(logs) {
            const container = document.getElementById('logsContainer');
            
            if (logs.length === 0) {
                container.innerHTML = '<div class="no-records">æš‚æ— è¯·æ±‚è®°å½•ï¼Œç­‰å¾…ä»£ç†è¯·æ±‚...</div>';
                return;
            }
            
            let logsHtml = '';
            logs.forEach(log => {
                const statusClass = log.status === 'success' ? 'success' : 'error';
                const statusText = log.status === 'success' ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥';
                const errorHtml = log.error ? `<div class="error-msg">âŒ ${log.error}</div>` : '';
                const thumbnailHtml = log.thumbnail ?
                    `<img src="/proxy?url=${encodeURIComponent(log.thumbnail)}" class="thumbnail" alt="ç¼©ç•¥å›¾" onerror="this.style.display='none'" />` : '';
                
                logsHtml += `
                    <div class="log-entry ${statusClass}">
                        <div class="timestamp">ğŸ• ${log.timestamp}</div>
                        <div class="url">ğŸ”— ${log.url}</div>
                        <div class="status ${statusClass}">${statusText}</div>
                        ${errorHtml}
                        ${thumbnailHtml}
                    </div>
                `;
            });
            
            container.innerHTML = logsHtml;
        }
        
        function createProxyRequest() {
            const urlInput = document.getElementById('proxyUrl');
            const resultDiv = document.getElementById('proxyResult');
            let url = urlInput.value.trim();
            urlInput.value = ""
            if (!url) {
                showResult('è¯·è¾“å…¥å›¾ç‰‡URL', 'error');
                return;
            }
            if(!url.startsWith("http"))
                url = "https://"+url
            // éªŒè¯URLæ ¼å¼
            if (!url.endsWith('.jpg') && !url.endsWith('.jpeg') && !url.endsWith('.png') &&
                !url.endsWith('.gif') && !url.endsWith('.webp') && !url.endsWith('.mp4') &&
                !url.endsWith('.mov') && !url.endsWith('.flv')) {
                showResult('URLæ ¼å¼ä¸æ­£ç¡®ï¼Œä»…æ”¯æŒ .jpg, .jpeg, .png, .gif, .webp, .mp4, .mov, .flv æ ¼å¼', 'error');
                return;
            }
            
            if (!url.includes('sina') && !url.includes('weibo')) {
                showResult('URLæ ¼å¼ä¸æ­£ç¡®ï¼Œä»…æ”¯æŒå¾®åšç›¸å…³å›¾ç‰‡', 'error');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showResult('æ­£åœ¨å¤„ç†è¯·æ±‚...', 'success');
            
            // åˆ›å»ºåä»£è¯·æ±‚
            fetch(`/proxy?url=${encodeURIComponent(url)}`)
                .then(response => {
                    if (response.ok) {
                        showResult(`åä»£è¯·æ±‚æˆåŠŸï¼ä»£ç†URL: ${window.location.origin}/proxy?url=${encodeURIComponent(url)}`, 'success');
                        // 2ç§’ååˆ·æ–°è®°å½•ä»¥æ˜¾ç¤ºæ–°è®°å½•
                        refreshLogs();
                    } else {
                        return response.text().then(text => {
                            showResult(`è¯·æ±‚å¤±è´¥: ${text}`, 'error');
                        });
                    }
                })
                .catch(error => {
                    showResult(`è¯·æ±‚å‡ºé”™: ${error.message}`, 'error');
                });
        }
        
        function showResult(message, type) {
            const resultDiv = document.getElementById('proxyResult');
            resultDiv.textContent = message;
            resultDiv.className = `proxy-result ${type}`;
            resultDiv.style.display = 'block';
        }
        
        // è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯30ç§’ï¼‰
        setInterval(() => refreshLogs(), 30000);
    </script>
</body>
</html>